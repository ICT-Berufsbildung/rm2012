<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Stored Procedures</title>

 </head>
 <body><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli.quickstart.prepared-statements.html">Prepared Statements</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli.quickstart.multiple-statement.html">Multiple Statements</a></div>
 <div class="up"><a href="mysqli.quickstart.html">Quickstart</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mysqli.quickstart.stored-procedures" class="section">
  <h2 class="title">Stored Procedures</h2>
  <p class="para">
   The MySQL database supports stored procedures. A stored procedure is a
   subroutine stored in the database catalog. Applications can call and
   execute the stored procedure. The <i>CALL</i>
   SQL statement is used to execute a stored procedure.
  </p>
  <p class="para">
   <em class="emphasis">Parameter</em>
  </p>
  <p class="para">
   Stored procedures can have <i>IN</i>,
   <i>INOUT</i> and <i>OUT</i> parameters,
   depending on the MySQL version. The mysqli interface has no special
   notion for the different kinds of parameters.
  </p>
  <p class="para">
   <em class="emphasis">IN parameter</em>
  </p>
  <p class="para">
   Input parameters are provided with the <i>CALL</i> statement.
   Please, make sure values are escaped correctly.
  </p>
  <p class="para">
   <div class="example" id="example-1568">
    <p><b>Example #1 Calling a stored procedure</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
$mysqli&nbsp;=&nbsp;new&nbsp;mysqli("example.com",&nbsp;"user",&nbsp;"password",&nbsp;"database");<br />if&nbsp;($mysqli-&gt;connect_errno))<br />&nbsp;echo&nbsp;"Failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;MySQL:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;connect_errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;connect_error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("CREATE&nbsp;TABLE&nbsp;test(id&nbsp;INT)"))<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"Table&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;PROCEDURE&nbsp;IF&nbsp;EXISTS&nbsp;p")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("CREATE&nbsp;PROCEDURE&nbsp;p(IN&nbsp;id_val&nbsp;INT)&nbsp;BEGIN&nbsp;INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES(id_val);&nbsp;END;"))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Stored&nbsp;procedure&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$mysqli-&gt;query("CALL&nbsp;p(1)"))<br />&nbsp;echo&nbsp;"CALL&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!($res&nbsp;=&nbsp;$mysqli-&gt;query("SELECT&nbsp;id&nbsp;FROM&nbsp;test")))<br />&nbsp;echo&nbsp;"SELECT&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />var_dump($res-&gt;fetch_assoc());</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
array(1) {
  [&quot;id&quot;]=&gt;
  string(1) &quot;1&quot;
}
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   <em class="emphasis">INOUT/OUT parameter</em>
  </p>
  <p class="para">
   The values of <i>INOUT</i>/<i>OUT</i>
   parameters are accessed using session variables.
  </p>
  <p class="para">
   <div class="example" id="example-1569">
    <p><b>Example #2 Using session variables</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
$mysqli&nbsp;=&nbsp;new&nbsp;mysqli("example.com",&nbsp;"user",&nbsp;"password",&nbsp;"database");<br />if&nbsp;($mysqli-&gt;connect_errno))<br />&nbsp;echo&nbsp;"Failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;MySQL:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;connect_errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;connect_error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;PROCEDURE&nbsp;IF&nbsp;EXISTS&nbsp;p")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query('CREATE&nbsp;PROCEDURE&nbsp;p(OUT&nbsp;msg&nbsp;VARCHAR(50))&nbsp;BEGIN&nbsp;SELECT&nbsp;"Hi!"&nbsp;INTO&nbsp;msg;&nbsp;END;'))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Stored&nbsp;procedure&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br /><br />if&nbsp;(!$mysqli-&gt;query("SET&nbsp;@msg&nbsp;=&nbsp;''")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("CALL&nbsp;p(@msg)"))<br />&nbsp;echo&nbsp;"CALL&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!($res&nbsp;=&nbsp;$mysqli-&gt;query("SELECT&nbsp;@msg&nbsp;as&nbsp;_p_out")))<br />&nbsp;echo&nbsp;"Fetch&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />$row&nbsp;=&nbsp;$res-&gt;fetch_assoc();<br />echo&nbsp;$row['_p_out'];</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Hi!
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   Application and framework developers may be able to provide a more convenient
   API using a mix of session variables and databased catalog inspection.
   However, please note the possible performance impact of a custom
   solution based on catalog inspection.
  </p>
  <p class="para">
   <em class="emphasis">Handling result sets</em>
  </p>
  <p class="para">
   Stored procedures can return result sets. Result sets returned from a
   stored procedure cannot be fetched correctly using <span class="function"><a href="mysqli.query.html" class="function">mysqli_query()</a></span>.
   The <span class="function"><a href="mysqli.query.html" class="function">mysqli_query()</a></span> function combines statement execution
   and fetching the first result set into a buffered result set, if any.
   However, there are additional stored procedure result sets hidden
   from the user which cause <span class="function"><a href="mysqli.query.html" class="function">mysqli_query()</a></span> to fail
   returning the user expected result sets.
  </p>
  <p class="para">
   Result sets returned from a stored procedure are fetched using
   <span class="function"><a href="mysqli.real-query.html" class="function">mysqli_real_query()</a></span> or <span class="function"><a href="mysqli.multi-query.html" class="function">mysqli_multi_query()</a></span>.
   Both functions allow fetching any number of result sets returned by a
   statement, such as <i>CALL</i>. Failing to fetch all
   result sets returned by a stored procedure causes an error.
  </p>
  <p class="para">
   <div class="example" id="example-1570">
    <p><b>Example #3 Fetching results from stored procedures</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
$mysqli&nbsp;=&nbsp;new&nbsp;mysqli("example.com",&nbsp;"user",&nbsp;"password",&nbsp;"database");<br />if&nbsp;($mysqli-&gt;connect_errno))<br />&nbsp;echo&nbsp;"Failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;MySQL:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;connect_errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;connect_error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("CREATE&nbsp;TABLE&nbsp;test(id&nbsp;INT)")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(1),&nbsp;(2),&nbsp;(3)"))<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"Table&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;PROCEDURE&nbsp;IF&nbsp;EXISTS&nbsp;p")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query('CREATE&nbsp;PROCEDURE&nbsp;p()&nbsp;READS&nbsp;SQL&nbsp;DATA&nbsp;BEGIN&nbsp;SELECT&nbsp;id&nbsp;FROM&nbsp;test;&nbsp;SELECT&nbsp;id&nbsp;+&nbsp;1&nbsp;FROM&nbsp;test;&nbsp;END;'))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Stored&nbsp;procedure&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$mysqli-&gt;multi_query("CALL&nbsp;p()"))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"CALL&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />do&nbsp;{<br />&nbsp;if&nbsp;($res&nbsp;=&nbsp;$mysqli-&gt;store_result())&nbsp;{<br />&nbsp;&nbsp;&nbsp;printf("---\n");<br />&nbsp;&nbsp;&nbsp;var_dump($res-&gt;fetch_all());<br />&nbsp;&nbsp;&nbsp;$res-&gt;free();<br />&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;if&nbsp;($mysqli-&gt;errno)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"Store&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br />&nbsp;}<br />}&nbsp;while&nbsp;($mysqli-&gt;more_results()&nbsp;&amp;&amp;&nbsp;$mysqli-&gt;next_result());</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
---
array(3) {
  [0]=&gt;
  array(1) {
    [0]=&gt;
    string(1) &quot;1&quot;
  }
  [1]=&gt;
  array(1) {
    [0]=&gt;
    string(1) &quot;2&quot;
  }
  [2]=&gt;
  array(1) {
    [0]=&gt;
    string(1) &quot;3&quot;
  }
}
---
array(3) {
  [0]=&gt;
  array(1) {
    [0]=&gt;
    string(1) &quot;2&quot;
  }
  [1]=&gt;
  array(1) {
    [0]=&gt;
    string(1) &quot;3&quot;
  }
  [2]=&gt;
  array(1) {
    [0]=&gt;
    string(1) &quot;4&quot;
  }
}
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   <em class="emphasis">Use of prepared statements</em>
  </p>
  <p class="para">
   No special handling is required when using the prepared statement
   interface for fetching results from the same stored procedure as above.
   The prepared statement and non-prepared statement interfaces are similar.
   Please note, that not every MYSQL server version may support
   preparing the <i>CALL</i> SQL statement.
  </p>
  <p class="para">
   <div class="example" id="example-1571">
    <p><b>Example #4 Stored Procedures and Prepared Statements</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
$mysqli&nbsp;=&nbsp;new&nbsp;mysqli("example.com",&nbsp;"user",&nbsp;"password",&nbsp;"database");<br />if&nbsp;($mysqli-&gt;connect_errno))<br />&nbsp;echo&nbsp;"Failed&nbsp;to&nbsp;connect&nbsp;to&nbsp;MySQL:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;connect_errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;connect_error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;TABLE&nbsp;IF&nbsp;EXISTS&nbsp;test")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("CREATE&nbsp;TABLE&nbsp;test(id&nbsp;INT)")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query("INSERT&nbsp;INTO&nbsp;test(id)&nbsp;VALUES&nbsp;(1),&nbsp;(2),&nbsp;(3)"))<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"Table&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$mysqli-&gt;query("DROP&nbsp;PROCEDURE&nbsp;IF&nbsp;EXISTS&nbsp;p")&nbsp;||<br />&nbsp;&nbsp;&nbsp;&nbsp;!$mysqli-&gt;query('CREATE&nbsp;PROCEDURE&nbsp;p()&nbsp;READS&nbsp;SQL&nbsp;DATA&nbsp;BEGIN&nbsp;SELECT&nbsp;id&nbsp;FROM&nbsp;test;&nbsp;SELECT&nbsp;id&nbsp;+&nbsp;1&nbsp;FROM&nbsp;test;&nbsp;END;'))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Stored&nbsp;procedure&nbsp;creation&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br /><br />if&nbsp;(!($stmt&nbsp;=&nbsp;$mysqli-&gt;prepare("CALL&nbsp;p()")))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Prepare&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$stmt-&gt;execute())<br />&nbsp;&nbsp;echo&nbsp;"Execute&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$stmt-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$stmt-&gt;error;<br /><br />do&nbsp;{<br />&nbsp;if&nbsp;($res&nbsp;=&nbsp;$stmt-&gt;get_result())&nbsp;{<br />&nbsp;&nbsp;&nbsp;printf("---\n");<br />&nbsp;&nbsp;&nbsp;var_dump(mysqli_fetch_all($res));<br />&nbsp;&nbsp;&nbsp;mysqli_free_result($res);<br />&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;if&nbsp;($stmt-&gt;errno)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;"Store&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$stmt-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$stmt-&gt;error;<br />&nbsp;}<br />}&nbsp;while&nbsp;($stmt-&gt;more_results()&nbsp;&amp;&amp;&nbsp;$stmt-&gt;next_result());</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   Of course, use of the bind API for fetching is supported as well.
  </p>
  <p class="para">
   <div class="example" id="example-1572">
    <p><b>Example #5 Stored Procedures and Prepared Statements using bind API</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
if&nbsp;(!($stmt&nbsp;=&nbsp;$mysqli-&gt;prepare("CALL&nbsp;p()")))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Prepare&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$mysqli-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$mysqli-&gt;error;<br /><br />if&nbsp;(!$stmt-&gt;execute())<br />&nbsp;&nbsp;echo&nbsp;"Execute&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$stmt-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$stmt-&gt;error;<br /><br />do&nbsp;{<br /><br />&nbsp;$id_out&nbsp;=&nbsp;NULL;<br />&nbsp;if&nbsp;(!$stmt-&gt;bind_result($id_out))<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"Bind&nbsp;failed:&nbsp;("&nbsp;.&nbsp;$stmt-&gt;errno&nbsp;.&nbsp;")&nbsp;"&nbsp;.&nbsp;$stmt-&gt;error;<br /><br />&nbsp;while&nbsp;($stmt-&gt;fetch())<br />&nbsp;&nbsp;&nbsp;echo&nbsp;"id&nbsp;=&nbsp;$id_out\n";<br />}&nbsp;while&nbsp;($stmt-&gt;more_results()&nbsp;&amp;&amp;&nbsp;$stmt-&gt;next_result());</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   <em class="emphasis">See also</em>
  </p>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><a href="mysqli.query.html" class="link"> <span class="methodname"><a href="mysqli.query.html" class="methodname">mysqli::query()</a></span></a></li>
    <li class="member"><a href="mysqli.multi-query.html" class="link"> <span class="methodname"><a href="mysqli.multi-query.html" class="methodname">mysqli::multi_query()</a></span></a></li>
    <li class="member"><a href="mysqli.next-result.html" class="link"> <span class="methodname"><b>mysqli_result::next-result()</b></span></a></li>
    <li class="member"><a href="mysqli.more-results.html" class="link"> <span class="methodname"><b>mysqli_result::more-results()</b></span></a></li>
   </ul>
  </p>
 </div><hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli.quickstart.prepared-statements.html">Prepared Statements</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli.quickstart.multiple-statement.html">Multiple Statements</a></div>
 <div class="up"><a href="mysqli.quickstart.html">Quickstart</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
